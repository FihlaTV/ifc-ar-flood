<!DOCTYPE html>
<html>
<head>
	<title>IFC - Augmented Reality Flood Simulation</title>
	<meta charset="UTF-8"/>

	<link href='http://fonts.googleapis.com/css?family=Fauna+One' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/css/style.css">

	<!--load helper libraries-->
	<script type="text/javascript" src="/js/lib/jquery-2.0.2.min.js"></script>

	<!--load webcam streaming libraries-->
	<script type="text/javascript" src="/js/lib/webrtc_adapter.js"></script>
	<script type="text/javascript" src="/js/streamvideo.js"></script>

	<!--load AR and 3D libraries-->
	<script type="text/javascript" src="/js/lib/ar/JSARToolKit.js"></script>
	<script type="text/javascript" src="/js/lib/three.min.js"></script>
	<script type="text/javascript" src="/js/lib/Detector.js"></script>
	<script type="text/javascript" src="/js/lib/stats.min.js"></script>
	<script type="text/javascript" src="/js/lib/dat.gui.min.js"></script>
	<script type="text/javascript" src="/js/lib/OBJMTLLoader.js"></script>
	<script type="text/javascript" src="/js/lib/MTLLoader.js"></script>
	<script type="text/javascript" src="/js/lib/BinaryLoader.js"></script>
	<script type="text/javascript" src="/js/skarf.js"></script>

	<script>

	var g_trackingThreshold = 128;
	var g_debug = true;

	function setupGui(skarf) {

		var options = {
			trackingThreshold: g_trackingThreshold,
			displayWireframe: false,
			displayLocalAxis: false,
		};

		var gui = new dat.GUI();
		gui.close();  //close GUI by default

		//Tracking folder
		var folder = gui.addFolder('Tracking');
		var control = folder.add(options, 'trackingThreshold', 0, 255).name('Threshold');
		function trackingThreshold_onChange(value)
		{
			skarf.arLib.threshold = value;
		}
		control.onChange(trackingThreshold_onChange);

		//Display folder
		folder = gui.addFolder('Display');

		var control = folder.add(options, 'displayWireframe').name('Wireframe');
		function toggleWireframe(value)
		{
			skarf.renderer.setWireframeVisible(value);
		}
		control.onChange(toggleWireframe);
		toggleWireframe(options.displayWireframe);

		control = folder.add(options, 'displayLocalAxis').name('Local Axis');
		function toggleLocalAxis(value)
		{
			skarf.renderer.setLocalAxisVisible(value);
		}
		control.onChange(toggleLocalAxis);
		toggleLocalAxis(options.displayLocalAxis);
	}

	$(document).ready(function()
	{
		//check for WebGL
		if (!Detector.webgl)
		{
			$('div').remove();
			Detector.addGetWebGLMessage();
			return;
		}

		console.log('Document is ready.');

		var canvas = $('#mainCanvas')[0];

		//stream to video element
		var video = $('#mainVideo')[0];
		streamVideo(video);
		var source = video;

		//create an AR library
		var jsArToolKitArLib = new JsArToolKitArLib({
			canvasElem: canvas,
			markerWidth: 120,
			threshold: g_trackingThreshold,
			debug: g_debug
		});

		//get the camera projection matrix from jsArToolKitArLib
		var camProjMatrixArray = new Float32Array(16);
		jsArToolKitArLib.flarParam.copyCameraMatrix(camProjMatrixArray, 10, 10000);

		//create a renderer
		var $threejsContainerElem = $('#threejs-container');
		var threeJsRenderer = new ThreeJsRenderer({
			//container to attach the Three.js-created renderer canvas
			rendererContainerElem: $threejsContainerElem,
			//width of the Three.js-created renderer canvas
			rendererCanvasWidth: canvas.width,
			//height of the Three.js-created renderer canvas
			rendererCanvasHeight: canvas.height,
			//the streaming canvas for background plane
			streamCanvasElem: canvas,
			camProjMatrixArray: camProjMatrixArray,
			modelsJsonFile: '/resources/models/models.json'
		});

		//create a framework
		var skarf = new SkArF({
			canvasElem: canvas,
			videoElem: video,
			arLib: jsArToolKitArLib,
			renderer: threeJsRenderer
		});

		//create a stats monitor
		stats = new Stats();
		$threejsContainerElem.append(stats.domElement);

		//setup GUI
		setupGui(skarf);

		//main loop
		function loop()
		{
			skarf.update();  //this will update the AR lib and renderer too
			stats.update();
			requestAnimationFrame(loop);
		}
		loop();

	});
	</script>
</head>
<body>
	<h2>Augmented reality using HTML5 technologies</h2>
	<div class="container" id="video-container">
		<div class="caption">&lt;video&gt;</div>
		<video id="mainVideo" width="640" height="480" autoplay="autoplay" muted="true"></video>
	</div>
	<div class="container" id="canvas-container">
		<div class="caption">&lt;canvas&gt;</div>
		<canvas id="mainCanvas" width="640" height="480"></canvas>
	</div>
	<div class="container" id="debugCanvas-container">
		<div class="caption">debug &lt;canvas&gt;</div>
		<canvas id="debugCanvas" width="640" height="480"></canvas>
	</div>
	<div class="container" id="threejs-container">
		<div class="caption">three.js &lt;canvas&gt;</div>
	</div>
</body>
</html>