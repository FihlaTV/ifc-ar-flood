<!DOCTYPE html>
<html>
<head>
	<title>IFC - Voxelize Test</title>
	<meta charset="UTF-8"/>
	
	<link rel="stylesheet" href="/css/style.css">
	<style type="text/css">
		#stats { position: absolute; top:0; left: 0 }
		#stats #fps { background: transparent !important }
		#stats #fps #fpsText { color: #aaa !important }
		#stats #fps #fpsGraph { display: block }
	</style>
	
	<!--load helper libraries-->
	<script type="text/javascript" src="/js/lib/jquery-2.0.2.min.js"></script>
	
	<!--load AR and 3D libraries-->
	<script type="text/javascript" src="/js/lib/three.min.js"></script>
	<script type="text/javascript" src="/js/lib/Detector.js"></script>
	<script type="text/javascript" src="/js/lib/stats.min.js"></script>
	<script type="text/javascript" src="/js/lib/dat.gui.min.js"></script>
	<script type="text/javascript" src="/js/lib/OrbitControls.js"></script>

	<script type="text/javascript" src="/js/lib/seedrandom.js"></script>

	<script type="text/javascript" src="/js/skvoxelizer.js"></script>
	
	<script>

	var clock = new THREE.Clock();

	function checkWebGl()
	{
		//check for WebGL
		if (!Detector.webgl)
		{
			$('div').remove();
			Detector.addGetWebGLMessage();
			throw new Error('Your browser does not seem to support WebGL');
		}
	}

	var renderer, scene, camera, controls;
	var materials = [];
	var localAxis;
	var sphereMesh;
	function setupThreejsScene()
	{
		//create renderer
		renderer = new THREE.WebGLRenderer({
			antialias : true
		});
		renderer.setSize(window.innerWidth, window.innerHeight-5);
		renderer.setClearColor('#111111', 1);
		var $container = $('#threejs-container');
		$container.append(renderer.domElement);

		//create scene
		scene = new THREE.Scene();

		//create camera
		camera = new THREE.PerspectiveCamera(25, renderer.domElement.width/renderer.domElement.height, 0.1, 1000);
		camera.position.set(8, 8, 15);
		camera.lookAt(new THREE.Vector3(0,0,0));

		//create controls for camera
		controls = new THREE.OrbitControls(camera);
		controls.userPanSpeed = 0.2;
		//controls.autoRotate = true;
		controls.modifierKey = 'alt';

		//create axis
		localAxis = new THREE.AxisHelper();
		scene.add(localAxis);

		//setup lights
		scene.add(new THREE.AmbientLight(0x111111));

		keyLight = new THREE.SpotLight(0xffff44, 0.6);
		keyLight.position.set(5, 15, -15);
		keyLight.target.position.set(0, 0, 0);
		scene.add(keyLight);

		fillLight = new THREE.SpotLight(0xff0044, 0.4);
		fillLight.position.set(5, 2, 15);
		fillLight.target.position.set(0, 0, 0);
		scene.add(fillLight);

		//create a sphere for voxelizing
		var sphereGeom = new THREE.SphereGeometry(2, 16, 32);
		// var sphereGeom = new THREE.CubeGeometry(2.2, 2.2, 2.2);
		// sphereGeom.applyMatrix(new THREE.Matrix4().makeRotationX(-Math.PI/2));
		var sphereMaterial = new THREE.MeshPhongMaterial();
		materials.push(sphereMaterial);
		sphereMesh = new THREE.Mesh(sphereGeom, sphereMaterial);
		// sphereMesh.visible = false;
		scene.add(sphereMesh);
	}

	function setupEvents()
	{
		window.addEventListener('resize', window_onResize, false);
	}

	function window_onResize(event)
	{
		//update camera projection
		camera.aspect = window.innerWidth / (window.innerHeight-5);
		camera.updateProjectionMatrix();

		//update renderer size
		renderer.setSize(window.innerWidth, window.innerHeight-5);
	}

	var stats;
	function setupStats()
	{
		//create a stats monitor
		stats = new Stats();
		$('body').append(stats.domElement);
	}

	var gui;
	var renderingFolder, displayFolder;
	var options = {
		renderingShadows: true,  //FIXME: this has to be init to true
		displayWireframe: true,
		displayLocalAxis: false,
	};
	function setupGui() {

		gui = new dat.GUI();
		//gui.close();  //close GUI by default

		//Rendering folder
		renderingFolder = gui.addFolder('Rendering');

		var control = renderingFolder.add(options, 'renderingShadows').name('Shadows');
		function changeRenderingShadows(value)
		{
			renderer.shadowMapAutoUpdate = value;
			if (!value)
			{
				renderer.clearTarget(keyLight.shadowMap);
			}
		}
		control.onChange(changeRenderingShadows);
		changeRenderingShadows(options.renderingShadows);

		//Display folder
		displayFolder = gui.addFolder('Display');
		
		control = displayFolder.add(options, 'displayWireframe').name('Wireframe');
		function toggleWireframe(value)
		{
			for (materialId in materials)
			{
				materials[materialId].wireframe = value;
			}
		}
		control.onChange(toggleWireframe);
		toggleWireframe(options.displayWireframe);
		
		control = displayFolder.add(options, 'displayLocalAxis').name('Local Axis');
		function toggleLocalAxis(value)
		{
			localAxis.visible = value;
		}
		control.onChange(toggleLocalAxis);
		toggleLocalAxis(options.displayLocalAxis);
	}

	var voxelizer;
	$(document).ready(function()
	{
		//check for WebGL
		checkWebGl();

		console.log('Document is ready.');
		
		//setup scene
		setupThreejsScene();

		//voxelize the sphere
		voxelizer = new SkVoxelizer(sphereMesh, 0.25, 0.25, 0.25);

		//setup events
		setupEvents();
		
		//setup stats monitor
		setupStats();
		
		//setup GUI
		setupGui();
		
		//main loop
		function loop()
		{
			var dt = clock.getDelta();  //have to call this before getElapsedTime()
			var time = clock.getElapsedTime();

			controls.update();

			//update sphere
			sphereMesh.position.x = Math.cos(time*1.5);
			sphereMesh.position.y = Math.sin(time*2.5);
			sphereMesh.position.z = Math.cos(time*2);

			//call voxelizer every frame to check frame rate
			voxelizer.voxelize();
			voxelizer.visualize(scene);

			renderer.autoClear = false;
			renderer.clear();
			renderer.render(scene, camera);

			stats.update();

			requestAnimationFrame(loop);
		}
		loop();
		
	});
	</script>
</head>
<body>
	<div id="threejs-container"></div>
	<div class="translucent" id="info-container">
		<div>Camera: [ Alt+LMB: rotate ] [ Alt+MMB: pan ] [ Alt+RMB: zoom ]</div>
	</div>
</body>
</html>